<link rel="import" href="elements.html">

<dom-module id="tm-crafty-block">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
  </template>
  <script>
    (function(Polymer) {
      Polymer({
        is: 'tm-crafty-block',
        properties: {
          app: { type: Object, notify: true},
          type: { type: String, notify: true, observer: '_typeChanged' },
          block: { type: Object, notify: true },
          x: { type: Number, notify: true },
          y: { type: Number, notify: true },
          draggable: { type: Boolean, notify: true },
          gravity: { type: Boolean, notify: true },
          solid: { type: Boolean, notify: true },
          gravityConst: { type: Number, notify: true, value: 30 }
        },
        observers: [
          'debug(draggable)',
          '_setDraggable(block,draggable)',
          '_setSolid(block,solid)',
          '_setGravity(block,gravity,gravityConst)'
        ],
        _typeChanged: function(newType,oldType) {
          console.log('Block type changed: ', oldType, newType);
          if (this.block !== undefined) {
            if (newType !== undefined && newType !== '') {
              if (oldType !== undefined && oldType !== '') {
                this.block.removeComponent(oldType);
              }
              this.block.addComponent(newType);
            }
          }
        },
        _setDraggable: function(block,draggable) {
          if (draggable) {
            block.addComponent('Draggable');
          }
        },
        _setSolid: function(block,solid) {
          if (solid) {
            block.addComponent('solid');
          }
        },
        _generateGravityConst: function() {
          if (this.gravity && this.gravityConst !== undefined) {
            return this.gravityConst;
          } else if (this.app.gravityConst !== undefined) {
            return this.app.gravityConst
          } else {
            return 30;
          }
        },
        _setGravity: function(block, gravity, gravityConst) {
          if (gravity === true) {
            if (!block.has('Gravity')) {
              block.addComponent('Gravity');
              block.gravity('solid');
            }
            block.gravityConst(this._generateGravityConst());
          } else {
            block.removeComponent('Gravity');
          }
        },
        debug: function(object) {
          console.log('DEBUG: ', object);
        },
        ready: function() {
          console.log('Element tm-crafty-block has been created.');
          //this.parentElement._onBlockCreation(this);
          this.block = Crafty.e("2D, Canvas");
          if (this.type !== undefined && this.type !== '') {
            this.block.addComponent(this.type);
          }
          this.fire('tm-crafty-block-created', this);
        }
      });

      function createBlock(gravity) {
        var mixins = "2D, DOM, block,Gravity";
        if (gravity) {
          mixins += ',Gravity';
        }
        var block = Crafty.e(mixins);
        if (gravity) {
          block.gravity('Floor');
        }
        return block;
      }
    })(window.Polymer);
  </script>
</dom-module>
