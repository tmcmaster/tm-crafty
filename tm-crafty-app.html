<link rel="import" href="elements.html">

<dom-module id="tm-crafty-app">
  <template>
    <style>
      :host {
        display: inline-block;
      }
      div {
        display: inline-block;
        border: solid lightgrey 1px;
      }
    </style>
    <div id="game"></div>
    <content/>
  </template>
  <script>
    (function(Polymer, Crafty) {
      Polymer({
        is: 'tm-crafty-app',
        properties: {
          width: { type:Number, notify:true },
          height: { type:Number, notify:true },
          gravity: { type: Number, notify: true },
          assets: { type: Object, notify: true }
        },
        observers: [
          'debug(prop)',
          '_setGravity(gravity)',
          '_loadAssets(assets)'
        ],
        listeners: {
          'tm-crafty-block-created': '_blockCreated'
        },
        _blockCreated: function(e) {
          console.log('-----# Block Created: ', e);
          //e.detail.app = this;
          const block = e.detail.block;
          const x = e.detail.x;
          const y = e.detail.y;
          this.iso.place(x, y, 0, block);
        },
        _setGravity: function(gravity) {
          const self = this;
          this.querySelectorAll('tm-crafty-block').forEach(function(element) {
            element.gravityConst = self.gravity;
          });
        },
        _loadAssets: function(assets) {
          Crafty.load({
            sprites : assets
          }, function() {
            console.log('TM-CRAFTY-APP: Sprites have been loaded.');
          },function(e) {
            console.log('TM-CRAFTY-APP: Sprite has been loaded: ', e);
          },function(e) {
            console.log('TM-CRAFTY-APP: There was a problem loading sprites.', e);
          });
        },
        getISO: function() {
          return this.iso;
        },
        debug: function(object) {
          console.log(object);
        },
        ready: function() {
          console.log('Element tm-crafty-app has been created.');
          Crafty.init(this.width,this.height, this.$.game);
          Crafty.sprite("../images/block.png", {block:[1,0,128,128]});
          this.iso = Crafty.isometric.size(128);
          const self = this;
          // this.addEventListener('tm-crafty-block-created', function(element) {
          //   console.log('------ Block Created: ', element.detail);
          //   element.detail.app = self;
          // });
        }
      });

      function createBlock(gravity) {
        var mixins = "2D, DOM, block,Gravity";
        if (gravity) {
          mixins += ',Gravity';
        }
        var block = Crafty.e(mixins);
        if (gravity) {
          block.gravity('Floor');
        }
        //block.attr({x:1,y,1});
        return block;
      }
    })(window.Polymer, window.Crafty);
  </script>
</dom-module>
